<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <!-- External resources: jQuery, Bootstrap 3.3.6, custom Flaticon set, FHIR client -->
    <script src='./src/jquery-2.1.4.min.js'></script>
    <script src="./src/jquery.loadTemplate.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./src/bootstrap.min.css" />
    <script src="./src/bootstrap.min.js"> </script>
    <link rel="stylesheet" type="text/css" href="/fonts/Flaticon.css"> 
    <script type="text/javascript" src='./js/fhir-client.js'></script>
    <!-- Internal resources, style and js-->
    <link rel="stylesheet" type="text/css" href="./css/index.css" />
    <script type="text/javascript" src='./js/langdict.js'></script>
    <script type="text/javascript" src="./js/mainview.js"></script>
    <script type="text/javascript" src="./js/profile.js"></script>
    <title>SysPharma Patient Portal Test</title>
  </head>
  <body>
    <script type="text/javascript" src="cordova.js"></script>

    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">
            <img alt="SysPharma" class="img-responsive" style="max-height:100%" src="img/SPlogo.png"> <!-- padding:-15px; -->
          </a>

        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#sphead" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>

        </div>

        <div class="collapse navbar-collapse" id="sphead">
        </div>
      </div>
    </nav>

    <div id="maincontent" class="container-fluid">
    </div>
  </body>

<script type="text/javascript">
	function getlangdict(newlang){
      sessionStorage.setItem("lang",newlang);
      if (newlang=="english"){
        sessionStorage.setItem("langdict",english);
        return english;
      } else if (newlang == "spanish"){
        sessionStorage.setItem("langdict",spanish);
        return spanish;
      }
      return {};
    }

    function changelang(newlang){
      sessionStorage.setItem("lang",newlang);
      var ldict = getlangdict(newlang);
      window.location.reload();
      return ldict;
    }

    var lang;
    var langdict;
    var smart;
    var pid;
    if (sessionStorage.getItem("lang")){
      lang = sessionStorage.getItem("lang");
    }else {
      lang = "spanish";
    }

    function loadlogin(){
      $("#sphead").loadTemplate("./html/header.html",langdict);
      $("#maincontent").loadTemplate("./html/login.html",langdict);
    }
    
    function loadmain(){
      smart = connectfhir(pid);
      var pq = smart.patient.read();
      if (pq){
        pq.done(function(p){
          $("#sphead").loadTemplate("./html/header.html",langdict);
          $("#maincontent").loadTemplate("./html/patmain.html",langdict);                          
        }).fail(function(p){
          pid = "";
          sessionStorage.removeItem("pid");
          var warningHTML = "<div class=\"alert alert-danger\" role=\"alert\">"+langdict["ld_warnlogin"]+"</div>";
          $("#logalertspace").html(warningHTML);
        });
      }
    }

    function loadprofile(){
      $("#sphead").loadTemplate("./html/header.html",langdict);
      $("#maincontent").loadTemplate("./html/profile.html",langdict); 
    }

    langdict = getlangdict(lang);
    if (sessionStorage.getItem("pid")){
      pid = sessionStorage.getItem("pid");
      loadmain();
    }
    else {
      loadlogin();
    }

    function dosubmit(){
      pid = $('#patid')[0].value;
      sessionStorage.setItem("pid", pid);
      loadmain();
    }

    function logout(){
      pid = null;
      smart = null;
      sessionStorage.removeItem("pid");
      loadlogin(); 
    }

    function connectfhir(pid){
      var demo = {
        serviceUrl: "https://fhir-open-api-dstu2.smarthealthit.org",//"http://localhost:8080",//
        patientId: pid,
        // patientId: "99912345",
        // patientId: "621799",
        auth: {
          type: 'none'
        }
      };
      var smart = FHIR.client(demo);
      return smart;
    }

  </script>


</html>
